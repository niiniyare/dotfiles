"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.mergeWithUnionArray = exports.mergePackages = exports.mergeBabel = exports.mergePluginData = exports.mergeJSONFiles = void 0;

var _path = _interopRequireDefault(require("path"));

var _fs = require("fs");

var _util = require("util");

var _mergeWith = _interopRequireDefault(require("lodash/mergeWith"));

var _isArray = _interopRequireDefault(require("lodash/isArray"));

var _union = _interopRequireDefault(require("lodash/union"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const getPluginFile = (pluginPath, pluginName, fileName) => {
  try {
    // eslint-disable-next-line @typescript-eslint/no-var-requires
    const pluginFile = require(_path.default.join(pluginPath, "plugins", pluginName, fileName));

    return pluginFile;
  } catch (e) {
    return undefined;
  }
};

const getStringFile = async (pluginPath, pluginName, fileName) => {
  try {
    const str = await (0, _util.promisify)(_fs.readFile)(_path.default.join(pluginPath, "plugins", pluginName, fileName), "utf8");

    if (typeof str === "string") {
      return str;
    } else {
      return "{}";
    }
  } catch (e) {
    return "{}";
  }
};

const mergeJSONFiles = (base = {}, pluginsPath, plugins, fileName) => {
  const baseFile = { ...base
  };
  const pluginFiles = plugins.map(plugin => {
    const file = getPluginFile(pluginsPath, plugin, fileName);
    return file !== null && file !== void 0 ? file : {};
  });
  return mergeWithUnionArray(baseFile, ...pluginFiles);
};

exports.mergeJSONFiles = mergeJSONFiles;

const mergePluginData = (base = {}, pluginsPath, plugins, fileName) => {
  const baseFile = { ...base
  };
  baseFile.plugins = [];
  plugins.map(plugin => {
    var _getPluginFile, _ref, _ref2, _ref3;

    if (["npm", "yarn", "react", "nextjs", "refine"].includes(plugin)) return;
    const file = (_getPluginFile = getPluginFile(pluginsPath, plugin, fileName)) !== null && _getPluginFile !== void 0 ? _getPluginFile : {};
    baseFile.plugins.push({
      name: (_ref = file.name) !== null && _ref !== void 0 ? _ref : plugin,
      description: (_ref2 = file.description) !== null && _ref2 !== void 0 ? _ref2 : "",
      url: (_ref3 = file.url) !== null && _ref3 !== void 0 ? _ref3 : ""
    });
  });
  return baseFile;
};

exports.mergePluginData = mergePluginData;

const mergeBabel = async (base, pluginsPath, plugins) => {
  var _ref4;

  const baseBabel = { ...base
  };
  const pluginRcs = await Promise.all(plugins.map(async plugin => {
    const str = await getStringFile(pluginsPath, plugin, ".babelrc");
    const parsed = JSON.parse(str);
    return parsed !== null && parsed !== void 0 ? parsed : {};
  }));
  const merged = mergeWithUnionArray(baseBabel, ...pluginRcs);
  const uniquePresets = [];
  const presetsSet = new Set((_ref4 = merged.presets) !== null && _ref4 !== void 0 ? _ref4 : []);
  presetsSet.forEach(el => uniquePresets.push(el));
  merged.presets = uniquePresets;
  return merged;
};

exports.mergeBabel = mergeBabel;

const mergePackages = (base = {}, pluginsPath, plugins, answers) => {
  const basePkg = { ...base
  };
  const pluginPkgs = plugins.map(plugin => {
    const pluginPkg = getPluginFile(pluginsPath, plugin, "package.json");
    const pluginPkgFn = getPluginFile(pluginsPath, plugin, "package.js");

    if (pluginPkgFn && pluginPkg) {
      const fnPkg = pluginPkgFn.apply(pluginPkg, answers);
      return fnPkg;
    } else if (pluginPkg) {
      return pluginPkg;
    }

    return {};
  });
  return mergeWithUnionArray(basePkg, ...pluginPkgs);
};

exports.mergePackages = mergePackages;

const unionArrays = (objValue, srcValue) => {
  if ((0, _isArray.default)(objValue) && (0, _isArray.default)(srcValue)) {
    return (0, _union.default)(objValue, srcValue);
  }
};

const mergeWithUnionArray = (...args) => (0, _mergeWith.default)({}, ...args, unionArrays);

exports.mergeWithUnionArray = mergeWithUnionArray;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9IZWxwZXIvbWVyZ2UvaW5kZXgudHMiXSwibmFtZXMiOlsiZ2V0UGx1Z2luRmlsZSIsInBsdWdpblBhdGgiLCJwbHVnaW5OYW1lIiwiZmlsZU5hbWUiLCJwbHVnaW5GaWxlIiwicmVxdWlyZSIsInBhdGgiLCJqb2luIiwiZSIsInVuZGVmaW5lZCIsImdldFN0cmluZ0ZpbGUiLCJzdHIiLCJyZWFkRmlsZSIsIm1lcmdlSlNPTkZpbGVzIiwiYmFzZSIsInBsdWdpbnNQYXRoIiwicGx1Z2lucyIsImJhc2VGaWxlIiwicGx1Z2luRmlsZXMiLCJtYXAiLCJwbHVnaW4iLCJmaWxlIiwibWVyZ2VXaXRoVW5pb25BcnJheSIsIm1lcmdlUGx1Z2luRGF0YSIsImluY2x1ZGVzIiwicHVzaCIsIm5hbWUiLCJkZXNjcmlwdGlvbiIsInVybCIsIm1lcmdlQmFiZWwiLCJiYXNlQmFiZWwiLCJwbHVnaW5SY3MiLCJQcm9taXNlIiwiYWxsIiwicGFyc2VkIiwiSlNPTiIsInBhcnNlIiwibWVyZ2VkIiwidW5pcXVlUHJlc2V0cyIsInByZXNldHNTZXQiLCJTZXQiLCJwcmVzZXRzIiwiZm9yRWFjaCIsImVsIiwibWVyZ2VQYWNrYWdlcyIsImFuc3dlcnMiLCJiYXNlUGtnIiwicGx1Z2luUGtncyIsInBsdWdpblBrZyIsInBsdWdpblBrZ0ZuIiwiZm5Qa2ciLCJhcHBseSIsInVuaW9uQXJyYXlzIiwib2JqVmFsdWUiLCJzcmNWYWx1ZSIsImFyZ3MiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQWdDQSxNQUFNQSxhQUlxQixHQUFHLENBQUNDLFVBQUQsRUFBYUMsVUFBYixFQUF5QkMsUUFBekIsS0FBc0M7QUFDaEUsTUFBSTtBQUNBO0FBQ0EsVUFBTUMsVUFBVSxHQUFHQyxPQUFPLENBQUNDLGNBQUtDLElBQUwsQ0FDdkJOLFVBRHVCLEVBRXZCLFNBRnVCLEVBR3ZCQyxVQUh1QixFQUl2QkMsUUFK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QUdPLElBQUlGLFNBQUosRUFBZTtBQUNsQixhQUFPQSxTQUFQO0FBQ0g7O0FBQ0QsV0FBTyxFQUFQO0FBQ0gsR0FuQmtCLENBQW5CO0FBcUJBLFNBQU8xQixtQkFBbUIsQ0FBQ3dCLE9BQUQsRUFBVSxHQUFHQyxVQUFiLENBQTFCO0FBSUgsQ0FoQ007Ozs7QUFrQ1AsTUFBTUssV0FBVyxHQUFHLENBQUNDLFFBQUQsRUFBcUJDLFFBQXJCLEtBQTRDO0FBQzVELE1BQUksc0JBQVFELFFBQVIsS0FBcUIsc0JBQVFDLFFBQVIsQ0FBekIsRUFBNEM7QUFDeEMsV0FBTyxvQkFBTUQsUUFBTixFQUFnQkMsUUFBaEIsQ0FBUDtBQUNIO0FBQ0osQ0FKRDs7QUFNTyxNQUFNaEMsbUJBQW1CLEdBQUcsQ0FDL0IsR0FBR2lDLElBRDRCLEtBRUwsd0JBQVUsRUFBVixFQUFjLEdBQUdBLElBQWpCLEVBQXVCSCxXQUF2QixDQUZ2QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBwYXRoIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgeyByZWFkRmlsZSB9IGZyb20gXCJmc1wiO1xuaW1wb3J0IHsgcHJvbWlzaWZ5IH0gZnJvbSBcInV0aWxcIjtcbmltcG9ydCBtZXJnZVdpdGggZnJvbSBcImxvZGFzaC9tZXJnZVdpdGhcIjtcbmltcG9ydCBpc0FycmF5IGZyb20gXCJsb2Rhc2gvaXNBcnJheVwiO1xuaW1wb3J0IHVuaW9uIGZyb20gXCJsb2Rhc2gvdW5pb25cIjtcblxudHlwZSBQa2dUeXBlID0gUmVjb3JkPHN0cmluZywgdW5rbm93bj47XG5cbnR5cGUgUGtnRm5UeXBlID0ge1xuICAgIGFwcGx5OiAoXG4gICAgICAgIHBrZzogUGtnVHlwZSxcbiAgICAgICAgYW5zd2VyczogUmVjb3JkPHN0cmluZywgc3RyaW5nIHwgc3RyaW5nW10gfCBib29sZWFuIHwgdW5kZWZpbmVkPixcbiAgICApID0+IFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xufTtcblxudHlwZSBNZXJnZXJGbiA9IChcbiAgICBiYXNlOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPixcbiAgICBwbHVnaW5zUGF0aDogc3RyaW5nLFxuICAgIHBsdWdpbnM6IHN0cmluZ1tdLFxuICAgIGZpbGVOYW1lOiBzdHJpbmcsXG4gICAgbWVyZ2VPcHRpb25zPzogUmVjb3JkPHN0cmluZywgdW5rbm93bj4sXG4pID0+IFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xuXG50eXBlIFBhY2thZ2VNZXJnZXJGbiA9IChcbiAgICBiYXNlOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPixcbiAgICBwbHVnaW5zUGF0aDogc3RyaW5nLFxuICAgIHBsdWdpbnM6IHN0cmluZ1tdLFxuICAgIGFuc3dlcnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZyB8IHN0cmluZ1tdIHwgYm9vbGVhbiB8IHVuZGVmaW5lZD4sXG4pID0+IFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xuXG50eXBlIEFzeW5jTWVyZ2VyRm4gPSAoXG4gICAgYmFzZTogUmVjb3JkPHN0cmluZywgdW5rbm93bj4sXG4gICAgcGx1Z2luc1BhdGg6IHN0cmluZyxcbiAgICBwbHVnaW5zOiBzdHJpbmdbXSxcbikgPT4gUHJvbWlzZTxSZWNvcmQ8c3RyaW5nLCB1bmtub3duPj47XG5cbmNvbnN0IGdldFBsdWdpbkZpbGU6IDxSZXR1cm5UeXBlIGV4dGVuZHMgYW55PihcbiAgICBwbHVnaW5QYXRoOiBzdHJpbmcsXG4gICAgcGx1Z2luTmFtZTogc3RyaW5nLFxuICAgIGZpbGVOYW1lOiBzdHJpbmcsXG4pID0+IFJldHVyblR5cGUgfCB1bmRlZmluZWQgPSAocGx1Z2luUGF0aCwgcGx1Z2luTmFtZSwgZmlsZU5hbWUpID0+IHtcbiAgICB0cnkge1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXZhci1yZXF1aXJlc1xuICAgICAgICBjb25zdCBwbHVnaW5GaWxlID0gcmVxdWlyZShwYXRoLmpvaW4oXG4gICAgICAgICAgICBwbHVnaW5QYXRoLFxuICAgICAgICAgICAgXCJwbHVnaW5zXCIsXG4gICAgICAgICAgICBwbHVnaW5OYW1lLFxuICAgICAgICAgICAgZmlsZU5hbWUsXG4gICAgICAgICkpO1xuXG4gICAgICAgIHJldHVybiBwbHVnaW5GaWxlO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG59O1xuXG5jb25zdCBnZXRTdHJpbmdGaWxlID0gYXN5bmMgKFxuICAgIHBsdWdpblBhdGg6IHN0cmluZyxcbiAgICBwbHVnaW5OYW1lOiBzdHJpbmcsXG4gICAgZmlsZU5hbWU6IHN0cmluZyxcbikgPT4ge1xuICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHN0ciA9IGF3YWl0IHByb21pc2lmeShyZWFkRmlsZSkoXG4gICAgICAgICAgICBwYXRoLmpvaW4ocGx1Z2luUGF0aCwgXCJwbHVnaW5zXCIsIHBsdWdpbk5hbWUsIGZpbGVOYW1lKSxcbiAgICAgICAgICAgIFwidXRmOFwiLFxuICAgICAgICApO1xuICAgICAgICBpZiAodHlwZW9mIHN0ciA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgICAgICAgcmV0dXJuIHN0cjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBcInt9XCI7XG4gICAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHJldHVybiBcInt9XCI7XG4gICAgfVxufTtcblxuZXhwb3J0IGNvbnN0IG1lcmdlSlNPTkZpbGVzOiBNZXJnZXJGbiA9IChcbiAgICBiYXNlID0ge30sXG4gICAgcGx1Z2luc1BhdGgsXG4gICAgcGx1Z2lucyxcbiAgICBmaWxlTmFtZSxcbikgPT4ge1xuICAgIGNvbnN0IGJhc2VGaWxlID0geyAuLi5iYXNlIH07XG4gICAgY29uc3QgcGx1Z2luRmlsZXMgPSBwbHVnaW5zLm1hcCgocGx1Z2luKSA9PiB7XG4gICAgICAgIGNvbnN0IGZpbGUgPSBnZXRQbHVnaW5GaWxlPFBrZ1R5cGU+KHBsdWdpbnNQYXRoLCBwbHVnaW4sIGZpbGVOYW1lKTtcbiAgICAgICAgcmV0dXJuIGZpbGUgPz8ge307XG4gICAgfSk7XG4gICAgcmV0dXJuIG1lcmdlV2l0aFVuaW9uQXJyYXkoYmFzZUZpbGUsIC4uLnBsdWdpbkZpbGVzKSBhcyBSZWNvcmQ8XG4gICAgICAgIHN0cmluZyxcbiAgICAgICAgdW5rbm93blxuICAgID47XG59O1xuXG50eXBlIFBsdWdpbkRhdGEgPSBSZWNvcmQ8XCJuYW1lXCIgfCBcImRlc2NyaXB0aW9uXCIgfCBcInVybFwiLCBzdHJpbmc+O1xuXG5leHBvcnQgY29uc3QgbWVyZ2VQbHVnaW5EYXRhOiBNZXJnZXJGbiA9IChcbiAgICBiYXNlID0ge30sXG4gICAgcGx1Z2luc1BhdGgsXG4gICAgcGx1Z2lucyxcbiAgICBmaWxlTmFtZSxcbikgPT4ge1xuICAgIGNvbnN0IGJhc2VGaWxlID0geyAuLi5iYXNlIH07XG4gICAgYmFzZUZpbGUucGx1Z2lucyA9IFtdO1xuICAgIHBsdWdpbnMubWFwKChwbHVnaW4pID0+IHtcbiAgICAgICAgaWYgKFtcIm5wbVwiLCBcInlhcm5cIiwgXCJyZWFjdFwiLCBcIm5leHRqc1wiLCBcInJlZmluZVwiXS5pbmNsdWRlcyhwbHVnaW4pKVxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICBjb25zdCBmaWxlID1cbiAgICAgICAgICAgIGdldFBsdWdpbkZpbGU8UGtnVHlwZT4ocGx1Z2luc1BhdGgsIHBsdWdpbiwgZmlsZU5hbWUpID8/IHt9O1xuXG4gICAgICAgIChiYXNlRmlsZS5wbHVnaW5zIGFzIFBsdWdpbkRhdGFbXSkucHVzaCh7XG4gICAgICAgICAgICBuYW1lOiAoZmlsZS5uYW1lIGFzIHN0cmluZykgPz8gcGx1Z2luLFxuICAgICAgICAgICAgZGVzY3JpcHRpb246IChmaWxlLmRlc2NyaXB0aW9uIGFzIHN0cmluZykgPz8gXCJcIixcbiAgICAgICAgICAgIHVybDogKGZpbGUudXJsIGFzIHN0cmluZykgPz8gXCJcIixcbiAgICAgICAgfSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIGJhc2VGaWxlO1xufTtcblxuZXhwb3J0IGNvbnN0IG1lcmdlQmFiZWw6IEFzeW5jTWVyZ2VyRm4gPSBhc3luYyAoYmFzZSwgcGx1Z2luc1BhdGgsIHBsdWdpbnMpID0+IHtcbiAgICBjb25zdCBiYXNlQmFiZWwgPSB7IC4uLmJhc2UgfTtcblxuICAgIGNvbnN0IHBsdWdpblJjcyA9IGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgICBwbHVnaW5zLm1hcChhc3luYyAocGx1Z2luKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBzdHIgPSBhd2FpdCBnZXRTdHJpbmdGaWxlKHBsdWdpbnNQYXRoLCBwbHVnaW4sIFwiLmJhYmVscmNcIik7XG4gICAgICAgICAgICBjb25zdCBwYXJzZWQgPSBKU09OLnBhcnNlKHN0cik7XG5cbiAgICAgICAgICAgIHJldHVybiBwYXJzZWQgPz8ge307XG4gICAgICAgIH0pLFxuICAgICk7XG5cbiAgICBjb25zdCBtZXJnZWQgPSBtZXJnZVdpdGhVbmlvbkFycmF5KGJhc2VCYWJlbCwgLi4ucGx1Z2luUmNzKSBhcyBSZWNvcmQ8XG4gICAgICAgIHN0cmluZyxcbiAgICAgICAgdW5rbm93blxuICAgID47XG5cbiAgICBjb25zdCB1bmlxdWVQcmVzZXRzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGNvbnN0IHByZXNldHNTZXQgPSBuZXcgU2V0KChtZXJnZWQucHJlc2V0cyBhcyBzdHJpbmdbXSkgPz8gW10pO1xuICAgIHByZXNldHNTZXQuZm9yRWFjaCgoZWwpID0+IHVuaXF1ZVByZXNldHMucHVzaChlbCkpO1xuICAgIG1lcmdlZC5wcmVzZXRzID0gdW5pcXVlUHJlc2V0cztcblxuICAgIHJldHVybiBtZXJnZWQ7XG59O1xuXG5leHBvcnQgY29uc3QgbWVyZ2VQYWNrYWdlczogUGFja2FnZU1lcmdlckZuID0gKFxuICAgIGJhc2UgPSB7fSxcbiAgICBwbHVnaW5zUGF0aCxcbiAgICBwbHVnaW5zLFxuICAgIGFuc3dlcnMsXG4pID0+IHtcbiAgICBjb25zdCBiYXNlUGtnID0geyAuLi5iYXNlIH07XG4gICAgY29uc3QgcGx1Z2luUGtncyA9IHBsdWdpbnMubWFwKChwbHVnaW4pID0+IHtcbiAgICAgICAgY29uc3QgcGx1Z2luUGtnID0gZ2V0UGx1Z2luRmlsZTxQa2dUeXBlPihcbiAgICAgICAgICAgIHBsdWdpbnNQYXRoLFxuICAgICAgICAgICAgcGx1Z2luLFxuICAgICAgICAgICAgXCJwYWNrYWdlLmpzb25cIixcbiAgICAgICAgKTtcbiAgICAgICAgY29uc3QgcGx1Z2luUGtnRm4gPSBnZXRQbHVnaW5GaWxlPFBrZ0ZuVHlwZT4oXG4gICAgICAgICAgICBwbHVnaW5zUGF0aCxcbiAgICAgICAgICAgIHBsdWdpbixcbiAgICAgICAgICAgIFwicGFja2FnZS5qc1wiLFxuICAgICAgICApO1xuXG4gICAgICAgIGlmIChwbHVnaW5Qa2dGbiAmJiBwbHVnaW5Qa2cpIHtcbiAgICAgICAgICAgIGNvbnN0IGZuUGtnID0gcGx1Z2luUGtnRm4uYXBwbHkocGx1Z2luUGtnLCBhbnN3ZXJzKTtcbiAgICAgICAgICAgIHJldHVybiBmblBrZztcbiAgICAgICAgfSBlbHNlIGlmIChwbHVnaW5Qa2cpIHtcbiAgICAgICAgICAgIHJldHVybiBwbHVnaW5Qa2c7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHt9O1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIG1lcmdlV2l0aFVuaW9uQXJyYXkoYmFzZVBrZywgLi4ucGx1Z2luUGtncykgYXMgUmVjb3JkPFxuICAgICAgICBzdHJpbmcsXG4gICAgICAgIHVua25vd25cbiAgICA+O1xufTtcblxuY29uc3QgdW5pb25BcnJheXMgPSAob2JqVmFsdWU6IHN0cmluZ1tdLCBzcmNWYWx1ZTogc3RyaW5nW10pID0+IHtcbiAgICBpZiAoaXNBcnJheShvYmpWYWx1ZSkgJiYgaXNBcnJheShzcmNWYWx1ZSkpIHtcbiAgICAgICAgcmV0dXJuIHVuaW9uKG9ialZhbHVlLCBzcmNWYWx1ZSk7XG4gICAgfVxufTtcblxuZXhwb3J0IGNvbnN0IG1lcmdlV2l0aFVuaW9uQXJyYXkgPSAoXG4gICAgLi4uYXJnczogUmVjb3JkPHN0cmluZywgdW5rbm93bj5bXVxuKTogUmVjb3JkPHN0cmluZywgdW5rbm93bj4gPT4gbWVyZ2VXaXRoKHt9LCAuLi5hcmdzLCB1bmlvbkFycmF5cyk7XG4iXX0=