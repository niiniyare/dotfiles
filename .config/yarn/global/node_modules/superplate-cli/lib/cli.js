"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _chalk = _interopRequireDefault(require("chalk"));

var _clear = _interopRequireDefault(require("clear"));

var _path = _interopRequireDefault(require("path"));

var _commander = _interopRequireDefault(require("commander"));

var _temp = require("temp");

var _sao = require("sao");

var _package = _interopRequireDefault(require("../package.json"));

var _Helper = require("./Helper");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const generator = _path.default.resolve(__dirname, "./"); // for cleanup temp files


(0, _temp.track)(); //

const cli = async () => {
  (0, _clear.default)();

  const program = _commander.default.name(_package.default.name).version(_package.default.version).arguments("<project-directory>").usage(`${_chalk.default.green("<project-directory>")} [options]`).description(_package.default.description).option("-s, --source <source-path>", "specify a custom source of plugins").option("-b, --branch <source-git-branch>", "specify a custom branch in source of plugins").option("-o, --preset <preset-name>", "specify a preset to use for the project").option("-l, --lucky", "use this option to generate a project with random answers").option("-d, --download <download>", "specify a download type (zip | git) of source", "git").option("-p, --project <project-name>", "specify a project type to use").option("-d, --debug", "print additional logs and skip install script").on("--help", () => {
    console.log();
    console.log(`  Only ${_chalk.default.green("<project-directory>")} is required.`);
    console.log();
    console.log(`  Provide a ${_chalk.default.green.bold`<project-directory>`} and you will be prompted to proceed.`);
    console.log();
    console.log(`  If you want to use custom plugins. You need to provide a source.`);
    console.log();
    console.log(`  A custom source can be one of:`);
    console.log(`  - a remote git repo: ${_chalk.default.green("https://github.com/my-plugin-source.git")}`);
    console.log(`  - if your source is a git repo you can also define a custom branch in it: ${_chalk.default.green("--branch canary or -b canary")}`);
    console.log(`  - if your source includes any presets, you can set them to prefill choices: ${_chalk.default.green("--preset cool-stack or -o cool-stack")}`);
    console.log(`  - if you are feeling lucky, you can always try your chance with random selected choices: ${_chalk.default.green("--lucky or -l")}`);
    console.log(`  - if you want to use zip instead of git clone: ${_chalk.default.green("--download zip or -d zip")}`);
    console.log(`  - a local path relative to the current working directory: ${_chalk.default.green("../my-source")}`);
    console.log();
  }).parse(process.argv);
  /**
   * Check for project-directory defined
   */


  const [projectDir] = program.args;
  const finalProjectDir = projectDir || (0, _Helper.getRandomName)().replace(/\s/g, "-").toLowerCase();
  /**
   * get source path
   */

  const source = await (0, _Helper.get_source)(program.source, program.branch, program.download);
  let {
    path: sourcePath
  } = source;
  const {
    error: sourceError
  } = source;

  if (sourceError) {
    console.error(`${_chalk.default.bold`${sourceError}`}`);
    console.log(`Source can be a remote git repository or a local path. ${program.branch ? "Make sure your specified branch exists." : ""}`);
    console.log();
    console.log("You provided:");
    console.log(`${_chalk.default.blueBright(program.source)}`);
    console.log();
    console.log(`Run ${_chalk.default.cyan(`${program.name()} --help`)} to see all options.`);
    (0, _temp.cleanupSync)();
    process.exit(1);
  }

  let projectType = program.project;
  const isMultiType = await (0, _Helper.is_multi_type)(sourcePath);
  /** handle presets, can either be partial or fully provided answers from `prompt.js > presets` */

  let presetAnswers = undefined;
  const selectedPreset = program.preset;
  const isLucky = program.lucky;

  if (selectedPreset && sourcePath && !isLucky) {
    const presets = await (0, _Helper.get_presets)(sourcePath);
    const preset = presets.find(p => p.name === selectedPreset);

    if (preset) {
      presetAnswers = preset.answers;
      projectType = preset.type;
    } else {
      console.log(`${_chalk.default.bold`${selectedPreset}`} is not a valid preset.`);
    }
  }

  if (sourcePath && isMultiType) {
    // get project types
    const projectTypes = await (0, _Helper.get_project_types)(sourcePath);
    const [finalSourcePath, selectedProjectType] = await (0, _Helper.prompt_project_types)(sourcePath, projectTypes, projectType);
    sourcePath = finalSourcePath;
    projectType = selectedProjectType;
  }

  if (isLucky && sourcePath) {
    const promptsAndChoices = await (0, _Helper.get_prompts_and_choices)(sourcePath);
    presetAnswers = (0, _Helper.get_random_answers)(promptsAndChoices);
  }

  const withAnswers = presetAnswers && Object.keys(presetAnswers).length > 0 ? true : undefined;
  const sao = new _sao.SAO({
    generator,
    outDir: finalProjectDir,
    logLevel: program.debug ? 4 : 1,
    appName: finalProjectDir,
    answers: withAnswers,
    extras: {
      debug: !!program.debug,
      projectType,
      paths: {
        sourcePath
      },
      presetAnswers
    }
  });
  await sao.run().catch(err => {
    console.log(`${program.name()} has encountered an error.`);
    console.log();
    console.log(`If you think this is caused by a bug. Please check out:`);
    console.log(`${_chalk.default.blueBright(_package.default.bugs.url)}`);
    console.log();
    console.error("ERROR", err);
    process.exit(1);
  });
  (0, _temp.cleanupSync)();
};

var _default = cli;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jbGkudHMiXSwibmFtZXMiOlsiZ2VuZXJhdG9yIiwicGF0aCIsInJlc29sdmUiLCJfX2Rpcm5hbWUiLCJjbGkiLCJwcm9ncmFtIiwiY29tbWFuZGVyIiwibmFtZSIsInBhY2thZ2VEYXRhIiwidmVyc2lvbiIsImFyZ3VtZW50cyIsInVzYWdlIiwiY2hhbGsiLCJncmVlbiIsImRlc2NyaXB0aW9uIiwib3B0aW9uIiwib24iLCJjb25zb2xlIiwibG9nIiwiYm9sZCIsInBhcnNlIiwicHJvY2VzcyIsImFyZ3YiLCJwcm9qZWN0RGlyIiwiYXJncyIsImZpbmFsUHJvamVjdERpciIsInJlcGxhY2UiLCJ0b0xvd2VyQ2FzZSIsInNvdXJjZSIsImJyYW5jaCIsImRvd25sb2FkIiwic291cmNlUGF0aCIsImVycm9yIiwic291cmNlRXJyb3IiLCJibHVlQnJpZ2h0IiwiY3lhbiIsImV4aXQiLCJwcm9qZWN0VHlwZSIsInByb2plY3QiLCJpc011bHRpVHlwZSIsInByZXNldEFuc3dlcnMiLCJ1bmRlZmluZWQiLCJzZWxlY3RlZFByZXNldCIsInByZXNldCIsImlzTHVja3kiLCJsdWNreSIsInByZXNldHMiLCJmaW5kIiwicCIsImFuc3dlcnMiLCJ0eXBlIiwicHJvamVjdFR5cGVzIiwiZmluYWxTb3VyY2VQYXRoIiwic2VsZWN0ZWRQcm9qZWN0VHlwZSIsInByb21wdHNBbmRDaG9pY2VzIiwid2l0aEFuc3dlcnMiLCJPYmplY3QiLCJrZXlzIiwibGVuZ3RoIiwic2FvIiwiU0FPIiwib3V0RGlyIiwibG9nTGV2ZWwiLCJkZWJ1ZyIsImFwcE5hbWUiLCJleHRyYXMiLCJwYXRocyIsInJ1biIsImNhdGNoIiwiZXJyIiwiYnVncyIsInVybCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOzs7O0FBV0EsTUFBTUEsU0FBUyxHQUFHQyxjQUFLQyxPQUFMLENBQWFDLFNBQWIsRUFBd0IsSUFB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QUFLaEJ3QixJQUFBQSxPQUFPLEVBQUVNLFdBTE87QUFNaEJVLElBQUFBLE1BQU0sRUFBRTtBQUNKRixNQUFBQSxLQUFLLEVBQUUsQ0FBQyxDQUFDMUQsT0FBTyxDQUFDMEQsS0FEYjtBQUVKMUIsTUFBQUEsV0FGSTtBQUdKNkIsTUFBQUEsS0FBSyxFQUFFO0FBQ0huQyxRQUFBQTtBQURHLE9BSEg7QUFNSlMsTUFBQUE7QUFOSTtBQU5RLEdBQVIsQ0FBWjtBQWdCQSxRQUFNbUIsR0FBRyxDQUFDUSxHQUFKLEdBQVVDLEtBQVYsQ0FBaUJDLEdBQUQsSUFBUztBQUMzQnBELElBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFhLEdBQUViLE9BQU8sQ0FBQ0UsSUFBUixFQUFlLDRCQUE5QjtBQUNBVSxJQUFBQSxPQUFPLENBQUNDLEdBQVI7QUFDQUQsSUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQWEseURBQWI7QUFDQUQsSUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQWEsR0FBRU4sZUFBTXNCLFVBQU4sQ0FBaUIxQixpQkFBWThELElBQVosQ0FBaUJDLEdBQWxDLENBQXVDLEVBQXREO0FBQ0F0RCxJQUFBQSxPQUFPLENBQUNDLEdBQVI7QUFDQUQsSUFBQUEsT0FBTyxDQUFDZSxLQUFSLENBQWMsT0FBZCxFQUF1QnFDLEdBQXZCO0FBQ0FoRCxJQUFBQSxPQUFPLENBQUNlLElBQVIsQ0FBYSxDQUFiO0FBQ0gsR0FSSyxDQUFOO0FBVUE7QUFDSCxDQWhNRDs7ZUFrTWVoQyxHIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNoYWxrIGZyb20gXCJjaGFsa1wiO1xuaW1wb3J0IGNsZWFyIGZyb20gXCJjbGVhclwiO1xuaW1wb3J0IHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCBjb21tYW5kZXIgZnJvbSBcImNvbW1hbmRlclwiO1xuaW1wb3J0IHsgY2xlYW51cFN5bmMsIHRyYWNrIH0gZnJvbSBcInRlbXBcIjtcbmltcG9ydCB7IE9wdGlvbnMsIFNBTyB9IGZyb20gXCJzYW9cIjtcblxuaW1wb3J0IHBhY2thZ2VEYXRhIGZyb20gXCIuLi9wYWNrYWdlLmpzb25cIjtcbmltcG9ydCB7XG4gICAgZ2V0X3NvdXJjZSxcbiAgICBnZXRfcHJvamVjdF90eXBlcyxcbiAgICBpc19tdWx0aV90eXBlLFxuICAgIHByb21wdF9wcm9qZWN0X3R5cGVzLFxuICAgIGdldF9wcmVzZXRzLFxuICAgIGdldF9wcm9tcHRzX2FuZF9jaG9pY2VzLFxuICAgIGdldF9yYW5kb21fYW5zd2VycyxcbiAgICBnZXRSYW5kb21OYW1lLFxufSBmcm9tIFwiQEhlbHBlclwiO1xuXG5jb25zdCBnZW5lcmF0b3IgPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBcIi4vXCIpO1xuXG4vLyBmb3IgY2xlYW51cCB0ZW1wIGZpbGVzXG50cmFjaygpO1xuLy9cbmNvbnN0IGNsaSA9IGFzeW5jICgpOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICBjbGVhcigpO1xuICAgIGNvbnN0IHByb2dyYW0gPSBjb21tYW5kZXJcbiAgICAgICAgLm5hbWUocGFja2FnZURhdGEubmFtZSlcbiAgICAgICAgLnZlcnNpb24ocGFja2FnZURhdGEudmVyc2lvbilcbiAgICAgICAgLmFyZ3VtZW50cyhcIjxwcm9qZWN0LWRpcmVjdG9yeT5cIilcbiAgICAgICAgLnVzYWdlKGAke2NoYWxrLmdyZWVuKFwiPHByb2plY3QtZGlyZWN0b3J5PlwiKX0gW29wdGlvbnNdYClcbiAgICAgICAgLmRlc2NyaXB0aW9uKHBhY2thZ2VEYXRhLmRlc2NyaXB0aW9uKVxuICAgICAgICAub3B0aW9uKFxuICAgICAgICAgICAgXCItcywgLS1zb3VyY2UgPHNvdXJjZS1wYXRoPlwiLFxuICAgICAgICAgICAgXCJzcGVjaWZ5IGEgY3VzdG9tIHNvdXJjZSBvZiBwbHVnaW5zXCIsXG4gICAgICAgIClcbiAgICAgICAgLm9wdGlvbihcbiAgICAgICAgICAgIFwiLWIsIC0tYnJhbmNoIDxzb3VyY2UtZ2l0LWJyYW5jaD5cIixcbiAgICAgICAgICAgIFwic3BlY2lmeSBhIGN1c3RvbSBicmFuY2ggaW4gc291cmNlIG9mIHBsdWdpbnNcIixcbiAgICAgICAgKVxuICAgICAgICAub3B0aW9uKFxuICAgICAgICAgICAgXCItbywgLS1wcmVzZXQgPHByZXNldC1uYW1lPlwiLFxuICAgICAgICAgICAgXCJzcGVjaWZ5IGEgcHJlc2V0IHRvIHVzZSBmb3IgdGhlIHByb2plY3RcIixcbiAgICAgICAgKVxuICAgICAgICAub3B0aW9uKFxuICAgICAgICAgICAgXCItbCwgLS1sdWNreVwiLFxuICAgICAgICAgICAgXCJ1c2UgdGhpcyBvcHRpb24gdG8gZ2VuZXJhdGUgYSBwcm9qZWN0IHdpdGggcmFuZG9tIGFuc3dlcnNcIixcbiAgICAgICAgKVxuICAgICAgICAub3B0aW9uKFxuICAgICAgICAgICAgXCItZCwgLS1kb3dubG9hZCA8ZG93bmxvYWQ+XCIsXG4gICAgICAgICAgICBcInNwZWNpZnkgYSBkb3dubG9hZCB0eXBlICh6aXAgfCBnaXQpIG9mIHNvdXJjZVwiLFxuICAgICAgICAgICAgXCJnaXRcIixcbiAgICAgICAgKVxuICAgICAgICAub3B0aW9uKFwiLXAsIC0tcHJvamVjdCA8cHJvamVjdC1uYW1lPlwiLCBcInNwZWNpZnkgYSBwcm9qZWN0IHR5cGUgdG8gdXNlXCIpXG4gICAgICAgIC5vcHRpb24oXCItZCwgLS1kZWJ1Z1wiLCBcInByaW50IGFkZGl0aW9uYWwgbG9ncyBhbmQgc2tpcCBpbnN0YWxsIHNjcmlwdFwiKVxuICAgICAgICAub24oXCItLWhlbHBcIiwgKCkgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5sb2coKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAgICAgICAgIGAgIE9ubHkgJHtjaGFsay5ncmVlbihcIjxwcm9qZWN0LWRpcmVjdG9yeT5cIil9IGlzIHJlcXVpcmVkLmAsXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgY29uc29sZS5sb2coKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAgICAgICAgIGAgIFByb3ZpZGUgYSAke2NoYWxrLmdyZWVuXG4gICAgICAgICAgICAgICAgICAgIC5ib2xkYDxwcm9qZWN0LWRpcmVjdG9yeT5gfSBhbmQgeW91IHdpbGwgYmUgcHJvbXB0ZWQgdG8gcHJvY2VlZC5gLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgICAgICAgICBgICBJZiB5b3Ugd2FudCB0byB1c2UgY3VzdG9tIHBsdWdpbnMuIFlvdSBuZWVkIHRvIHByb3ZpZGUgYSBzb3VyY2UuYCxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coYCAgQSBjdXN0b20gc291cmNlIGNhbiBiZSBvbmUgb2Y6YCk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgICAgICAgICBgICAtIGEgcmVtb3RlIGdpdCByZXBvOiAke2NoYWxrLmdyZWVuKFxuICAgICAgICAgICAgICAgICAgICBcImh0dHBzOi8vZ2l0aHViLmNvbS9teS1wbHVnaW4tc291cmNlLmdpdFwiLFxuICAgICAgICAgICAgICAgICl9YCxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgICAgICAgICBgICAtIGlmIHlvdXIgc291cmNlIGlzIGEgZ2l0IHJlcG8geW91IGNhbiBhbHNvIGRlZmluZSBhIGN1c3RvbSBicmFuY2ggaW4gaXQ6ICR7Y2hhbGsuZ3JlZW4oXG4gICAgICAgICAgICAgICAgICAgIFwiLS1icmFuY2ggY2FuYXJ5IG9yIC1iIGNhbmFyeVwiLFxuICAgICAgICAgICAgICAgICl9YCxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgICAgICAgICBgICAtIGlmIHlvdXIgc291cmNlIGluY2x1ZGVzIGFueSBwcmVzZXRzLCB5b3UgY2FuIHNldCB0aGVtIHRvIHByZWZpbGwgY2hvaWNlczogJHtjaGFsay5ncmVlbihcbiAgICAgICAgICAgICAgICAgICAgXCItLXByZXNldCBjb29sLXN0YWNrIG9yIC1vIGNvb2wtc3RhY2tcIixcbiAgICAgICAgICAgICAgICApfWAsXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgICAgICAgYCAgLSBpZiB5b3UgYXJlIGZlZWxpbmcgbHVja3ksIHlvdSBjYW4gYWx3YXlzIHRyeSB5b3VyIGNoYW5jZSB3aXRoIHJhbmRvbSBzZWxlY3RlZCBjaG9pY2VzOiAke2NoYWxrLmdyZWVuKFxuICAgICAgICAgICAgICAgICAgICBcIi0tbHVja3kgb3IgLWxcIixcbiAgICAgICAgICAgICAgICApfWAsXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgICAgICAgYCAgLSBpZiB5b3Ugd2FudCB0byB1c2UgemlwIGluc3RlYWQgb2YgZ2l0IGNsb25lOiAke2NoYWxrLmdyZWVuKFxuICAgICAgICAgICAgICAgICAgICBcIi0tZG93bmxvYWQgemlwIG9yIC1kIHppcFwiLFxuICAgICAgICAgICAgICAgICl9YCxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgICAgICAgICBgICAtIGEgbG9jYWwgcGF0aCByZWxhdGl2ZSB0byB0aGUgY3VycmVudCB3b3JraW5nIGRpcmVjdG9yeTogJHtjaGFsay5ncmVlbihcbiAgICAgICAgICAgICAgICAgICAgXCIuLi9teS1zb3VyY2VcIixcbiAgICAgICAgICAgICAgICApfWAsXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgY29uc29sZS5sb2coKTtcbiAgICAgICAgfSlcbiAgICAgICAgLnBhcnNlKHByb2Nlc3MuYXJndik7XG5cbiAgICAvKipcbiAgICAgKiBDaGVjayBmb3IgcHJvamVjdC1kaXJlY3RvcnkgZGVmaW5lZFxuICAgICAqL1xuICAgIGNvbnN0IFtwcm9qZWN0RGlyXSA9IHByb2dyYW0uYXJncztcblxuICAgIGNvbnN0IGZpbmFsUHJvamVjdERpciA9XG4gICAgICAgIHByb2plY3REaXIgfHwgZ2V0UmFuZG9tTmFtZSgpLnJlcGxhY2UoL1xccy9nLCBcIi1cIikudG9Mb3dlckNhc2UoKTtcblxuICAgIC8qKlxuICAgICAqIGdldCBzb3VyY2UgcGF0aFxuICAgICAqL1xuICAgIGNvbnN0IHNvdXJjZSA9IGF3YWl0IGdldF9zb3VyY2UoXG4gICAgICAgIHByb2dyYW0uc291cmNlLFxuICAgICAgICBwcm9ncmFtLmJyYW5jaCxcbiAgICAgICAgcHJvZ3JhbS5kb3dubG9hZCxcbiAgICApO1xuXG4gICAgbGV0IHsgcGF0aDogc291cmNlUGF0aCB9ID0gc291cmNlO1xuICAgIGNvbnN0IHsgZXJyb3I6IHNvdXJjZUVycm9yIH0gPSBzb3VyY2U7XG5cbiAgICBpZiAoc291cmNlRXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihgJHtjaGFsay5ib2xkYCR7c291cmNlRXJyb3J9YH1gKTtcbiAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgICBgU291cmNlIGNhbiBiZSBhIHJlbW90ZSBnaXQgcmVwb3NpdG9yeSBvciBhIGxvY2FsIHBhdGguICR7XG4gICAgICAgICAgICAgICAgcHJvZ3JhbS5icmFuY2ggPyBcIk1ha2Ugc3VyZSB5b3VyIHNwZWNpZmllZCBicmFuY2ggZXhpc3RzLlwiIDogXCJcIlxuICAgICAgICAgICAgfWAsXG4gICAgICAgICk7XG4gICAgICAgIGNvbnNvbGUubG9nKCk7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiWW91IHByb3ZpZGVkOlwiKTtcbiAgICAgICAgY29uc29sZS5sb2coYCR7Y2hhbGsuYmx1ZUJyaWdodChwcm9ncmFtLnNvdXJjZSl9YCk7XG4gICAgICAgIGNvbnNvbGUubG9nKCk7XG4gICAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAgICAgYFJ1biAke2NoYWxrLmN5YW4oYCR7cHJvZ3JhbS5uYW1lKCl9IC0taGVscGApfSB0byBzZWUgYWxsIG9wdGlvbnMuYCxcbiAgICAgICAgKTtcbiAgICAgICAgY2xlYW51cFN5bmMoKTtcbiAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgIH1cblxuICAgIGxldCBwcm9qZWN0VHlwZSA9IHByb2dyYW0ucHJvamVjdDtcbiAgICBjb25zdCBpc011bHRpVHlwZSA9IGF3YWl0IGlzX211bHRpX3R5cGUoc291cmNlUGF0aCk7XG5cbiAgICAvKiogaGFuZGxlIHByZXNldHMsIGNhbiBlaXRoZXIgYmUgcGFydGlhbCBvciBmdWxseSBwcm92aWRlZCBhbnN3ZXJzIGZyb20gYHByb21wdC5qcyA+IHByZXNldHNgICovXG4gICAgbGV0IHByZXNldEFuc3dlcnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gfCB1bmRlZmluZWQgPSB1bmRlZmluZWQ7XG4gICAgY29uc3Qgc2VsZWN0ZWRQcmVzZXQgPSBwcm9ncmFtLnByZXNldDtcbiAgICBjb25zdCBpc0x1Y2t5ID0gcHJvZ3JhbS5sdWNreTtcblxuICAgIGlmIChzZWxlY3RlZFByZXNldCAmJiBzb3VyY2VQYXRoICYmICFpc0x1Y2t5KSB7XG4gICAgICAgIGNvbnN0IHByZXNldHMgPSBhd2FpdCBnZXRfcHJlc2V0cyhzb3VyY2VQYXRoKTtcblxuICAgICAgICBjb25zdCBwcmVzZXQgPSBwcmVzZXRzLmZpbmQoKHApID0+IHAubmFtZSA9PT0gc2VsZWN0ZWRQcmVzZXQpO1xuXG4gICAgICAgIGlmIChwcmVzZXQpIHtcbiAgICAgICAgICAgIHByZXNldEFuc3dlcnMgPSBwcmVzZXQuYW5zd2VycztcbiAgICAgICAgICAgIHByb2plY3RUeXBlID0gcHJlc2V0LnR5cGU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgICAgICAgICBgJHtjaGFsay5ib2xkYCR7c2VsZWN0ZWRQcmVzZXR9YH0gaXMgbm90IGEgdmFsaWQgcHJlc2V0LmAsXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHNvdXJjZVBhdGggJiYgaXNNdWx0aVR5cGUpIHtcbiAgICAgICAgLy8gZ2V0IHByb2plY3QgdHlwZXNcbiAgICAgICAgY29uc3QgcHJvamVjdFR5cGVzID0gYXdhaXQgZ2V0X3Byb2plY3RfdHlwZXMoc291cmNlUGF0aCk7XG5cbiAgICAgICAgY29uc3QgW1xuICAgICAgICAgICAgZmluYWxTb3VyY2VQYXRoLFxuICAgICAgICAgICAgc2VsZWN0ZWRQcm9qZWN0VHlwZSxcbiAgICAgICAgXSA9IGF3YWl0IHByb21wdF9wcm9qZWN0X3R5cGVzKHNvdXJjZVBhdGgsIHByb2plY3RUeXBlcywgcHJvamVjdFR5cGUpO1xuXG4gICAgICAgIHNvdXJjZVBhdGggPSBmaW5hbFNvdXJjZVBhdGg7XG4gICAgICAgIHByb2plY3RUeXBlID0gc2VsZWN0ZWRQcm9qZWN0VHlwZTtcbiAgICB9XG5cbiAgICBpZiAoaXNMdWNreSAmJiBzb3VyY2VQYXRoKSB7XG4gICAgICAgIGNvbnN0IHByb21wdHNBbmRDaG9pY2VzID0gYXdhaXQgZ2V0X3Byb21wdHNfYW5kX2Nob2ljZXMoc291cmNlUGF0aCk7XG4gICAgICAgIHByZXNldEFuc3dlcnMgPSBnZXRfcmFuZG9tX2Fuc3dlcnMocHJvbXB0c0FuZENob2ljZXMpO1xuICAgIH1cblxuICAgIGNvbnN0IHdpdGhBbnN3ZXJzID1cbiAgICAgICAgcHJlc2V0QW5zd2VycyAmJiBPYmplY3Qua2V5cyhwcmVzZXRBbnN3ZXJzKS5sZW5ndGggPiAwXG4gICAgICAgICAgICA/IHRydWVcbiAgICAgICAgICAgIDogdW5kZWZpbmVkO1xuXG4gICAgY29uc3Qgc2FvID0gbmV3IFNBTyh7XG4gICAgICAgIGdlbmVyYXRvcixcbiAgICAgICAgb3V0RGlyOiBmaW5hbFByb2plY3REaXIsXG4gICAgICAgIGxvZ0xldmVsOiBwcm9ncmFtLmRlYnVnID8gNCA6IDEsXG4gICAgICAgIGFwcE5hbWU6IGZpbmFsUHJvamVjdERpcixcbiAgICAgICAgYW5zd2Vyczogd2l0aEFuc3dlcnMsXG4gICAgICAgIGV4dHJhczoge1xuICAgICAgICAgICAgZGVidWc6ICEhcHJvZ3JhbS5kZWJ1ZyxcbiAgICAgICAgICAgIHByb2plY3RUeXBlLFxuICAgICAgICAgICAgcGF0aHM6IHtcbiAgICAgICAgICAgICAgICBzb3VyY2VQYXRoLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHByZXNldEFuc3dlcnMsXG4gICAgICAgIH0sXG4gICAgfSBhcyBPcHRpb25zKTtcblxuICAgIGF3YWl0IHNhby5ydW4oKS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKGAke3Byb2dyYW0ubmFtZSgpfSBoYXMgZW5jb3VudGVyZWQgYW4gZXJyb3IuYCk7XG4gICAgICAgIGNvbnNvbGUubG9nKCk7XG4gICAgICAgIGNvbnNvbGUubG9nKGBJZiB5b3UgdGhpbmsgdGhpcyBpcyBjYXVzZWQgYnkgYSBidWcuIFBsZWFzZSBjaGVjayBvdXQ6YCk7XG4gICAgICAgIGNvbnNvbGUubG9nKGAke2NoYWxrLmJsdWVCcmlnaHQocGFja2FnZURhdGEuYnVncy51cmwpfWApO1xuICAgICAgICBjb25zb2xlLmxvZygpO1xuICAgICAgICBjb25zb2xlLmVycm9yKFwiRVJST1JcIiwgZXJyKTtcbiAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgIH0pO1xuXG4gICAgY2xlYW51cFN5bmMoKTtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGNsaTtcbiJdfQ==